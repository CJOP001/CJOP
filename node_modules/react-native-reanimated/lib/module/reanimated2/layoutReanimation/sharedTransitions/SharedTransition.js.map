{"version":3,"names":["withTiming","LayoutAnimationType","SharedTransitionType","configureLayoutAnimations","ProgressTransitionManager","supportedProps","SharedTransition","constructor","_defineProperty","undefined","custom","customAnimationFactory","_customAnimationFactory","progressAnimation","progressAnimationCallback","_customProgressAnimation","viewTag","values","progress","newStyles","_notifyAboutProgress","duration","_transitionDuration","defaultTransitionType","transitionType","_defaultTransitionType","registerTransition","sharedTransitionTag","transitionAnimation","getTransitionAnimation","getProgressAnimation","ANIMATION","PROGRESS_ANIMATION","layoutAnimationType","SHARED_ELEMENT_TRANSITION","SHARED_ELEMENT_TRANSITION_PROGRESS","_progressTransitionManager","addProgressAnimation","unregisterTransition","removeProgressAnimation","_animation","buildAnimation","_progressAnimation","buildProgressAnimation","animationFactory","transitionDuration","animations","initialValues","key","includes","Error","propName","matrix","targetTransformMatrix","transformMatrix","keyToTargetValue","charAt","toUpperCase","slice","currentTransformMatrix","keyToCurrentValue","propertyName","currentMatrix","targetMatrix","newMatrix","Array","i","PropertyName","currentValue","targetValue"],"sources":["SharedTransition.ts"],"sourcesContent":["import { withTiming } from '../../animation';\nimport type {\n  SharedTransitionAnimationsFunction,\n  SharedTransitionAnimationsValues,\n  CustomProgressAnimation,\n  ProgressAnimation,\n} from '../animationBuilder/commonTypes';\nimport {\n  LayoutAnimationType,\n  SharedTransitionType,\n} from '../animationBuilder/commonTypes';\nimport type { StyleProps } from '../../commonTypes';\nimport { configureLayoutAnimations } from '../../core';\nimport { ProgressTransitionManager } from './ProgressTransitionManager';\n\nconst supportedProps = [\n  'width',\n  'height',\n  'originX',\n  'originY',\n  'transform',\n  'borderRadius',\n];\n\ntype AnimationFactory = (\n  values: SharedTransitionAnimationsValues\n) => StyleProps;\n\nexport class SharedTransition {\n  private _customAnimationFactory: AnimationFactory | null = null;\n  private _animation: SharedTransitionAnimationsFunction | null = null;\n  private _transitionDuration = 500;\n  private _customProgressAnimation?: ProgressAnimation = undefined;\n  private _progressAnimation?: ProgressAnimation = undefined;\n  private _defaultTransitionType?: SharedTransitionType = undefined;\n  private static _progressTransitionManager = new ProgressTransitionManager();\n\n  public custom(customAnimationFactory: AnimationFactory): SharedTransition {\n    this._customAnimationFactory = customAnimationFactory;\n    return this;\n  }\n\n  public progressAnimation(\n    progressAnimationCallback: CustomProgressAnimation\n  ): SharedTransition {\n    this._customProgressAnimation = (viewTag, values, progress) => {\n      'worklet';\n      const newStyles = progressAnimationCallback(values, progress);\n      _notifyAboutProgress(viewTag, newStyles, true);\n    };\n    return this;\n  }\n\n  public duration(duration: number): SharedTransition {\n    this._transitionDuration = duration;\n    return this;\n  }\n\n  public defaultTransitionType(\n    transitionType: SharedTransitionType\n  ): SharedTransition {\n    this._defaultTransitionType = transitionType;\n    return this;\n  }\n\n  public registerTransition(\n    viewTag: number,\n    sharedTransitionTag: string\n  ): void {\n    const transitionAnimation = this.getTransitionAnimation();\n    const progressAnimation = this.getProgressAnimation();\n    if (!this._defaultTransitionType) {\n      if (this._customAnimationFactory && !this._customProgressAnimation) {\n        this._defaultTransitionType = SharedTransitionType.ANIMATION;\n      } else {\n        this._defaultTransitionType = SharedTransitionType.PROGRESS_ANIMATION;\n      }\n    }\n    const layoutAnimationType =\n      this._defaultTransitionType === SharedTransitionType.ANIMATION\n        ? LayoutAnimationType.SHARED_ELEMENT_TRANSITION\n        : LayoutAnimationType.SHARED_ELEMENT_TRANSITION_PROGRESS;\n    configureLayoutAnimations(\n      viewTag,\n      layoutAnimationType,\n      transitionAnimation,\n      sharedTransitionTag\n    );\n    SharedTransition._progressTransitionManager.addProgressAnimation(\n      viewTag,\n      progressAnimation\n    );\n  }\n\n  public unregisterTransition(viewTag: number): void {\n    SharedTransition._progressTransitionManager.removeProgressAnimation(\n      viewTag\n    );\n  }\n\n  private getTransitionAnimation(): SharedTransitionAnimationsFunction {\n    if (!this._animation) {\n      this.buildAnimation();\n    }\n    return this._animation!;\n  }\n\n  private getProgressAnimation(): ProgressAnimation {\n    if (!this._progressAnimation) {\n      this.buildProgressAnimation();\n    }\n    return this._progressAnimation!;\n  }\n\n  private buildAnimation() {\n    const animationFactory = this._customAnimationFactory;\n    const transitionDuration = this._transitionDuration;\n    this._animation = (values: SharedTransitionAnimationsValues) => {\n      'worklet';\n      let animations: {\n        [key: string]: any;\n      } = {};\n      const initialValues: {\n        [key: string]: any;\n      } = {};\n\n      if (animationFactory) {\n        animations = animationFactory(values);\n        for (const key in animations) {\n          if (!supportedProps.includes(key)) {\n            throw Error(`The prop '${key}' is not supported yet.`);\n          }\n        }\n      } else {\n        for (const propName of supportedProps) {\n          if (propName === 'transform') {\n            const matrix = values.targetTransformMatrix;\n            animations.transformMatrix = withTiming(matrix, {\n              duration: transitionDuration,\n            });\n          } else {\n            const keyToTargetValue =\n              'target' + propName.charAt(0).toUpperCase() + propName.slice(1);\n            animations[propName] = withTiming(values[keyToTargetValue], {\n              duration: transitionDuration,\n            });\n          }\n        }\n      }\n\n      for (const propName in animations) {\n        if (propName === 'transform') {\n          initialValues.transformMatrix = values.currentTransformMatrix;\n        } else {\n          const keyToCurrentValue =\n            'current' + propName.charAt(0).toUpperCase() + propName.slice(1);\n          initialValues[propName] = values[keyToCurrentValue];\n        }\n      }\n\n      return { initialValues, animations };\n    };\n  }\n\n  private buildProgressAnimation() {\n    if (this._customProgressAnimation) {\n      this._progressAnimation = this._customProgressAnimation;\n      return;\n    }\n    this._progressAnimation = (viewTag, values, progress) => {\n      'worklet';\n      const newStyles: { [key: string]: number | number[] } = {};\n      for (const propertyName of supportedProps) {\n        if (propertyName === 'transform') {\n          // this is not the perfect solution, but at this moment it just interpolates the whole\n          // matrix instead of interpolating scale, translate, rotate, etc. separately\n          const currentMatrix = values.currentTransformMatrix as number[];\n          const targetMatrix = values.targetTransformMatrix as number[];\n          const newMatrix = new Array(9);\n          for (let i = 0; i < 9; i++) {\n            newMatrix[i] =\n              progress * (targetMatrix[i] - currentMatrix[i]) +\n              currentMatrix[i];\n          }\n          newStyles.transformMatrix = newMatrix;\n        } else {\n          // PropertyName == propertyName with capitalized fist letter, (width -> Width)\n          const PropertyName =\n            propertyName.charAt(0).toUpperCase() + propertyName.slice(1);\n          const currentValue = values['current' + PropertyName] as number;\n          const targetValue = values['target' + PropertyName] as number;\n          newStyles[propertyName] =\n            progress * (targetValue - currentValue) + currentValue;\n        }\n      }\n      _notifyAboutProgress(viewTag, newStyles, true);\n    };\n  }\n\n  // static builder methods\n\n  public static custom(\n    customAnimationFactory: AnimationFactory\n  ): SharedTransition {\n    return new SharedTransition().custom(customAnimationFactory);\n  }\n\n  public static duration(duration: number): SharedTransition {\n    return new SharedTransition().duration(duration);\n  }\n\n  public static progressAnimation(\n    progressAnimationCallback: CustomProgressAnimation\n  ): SharedTransition {\n    return new SharedTransition().progressAnimation(progressAnimationCallback);\n  }\n\n  public static defaultTransitionType(\n    transitionType: SharedTransitionType\n  ): SharedTransition {\n    return new SharedTransition().defaultTransitionType(transitionType);\n  }\n}\n"],"mappings":"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"}