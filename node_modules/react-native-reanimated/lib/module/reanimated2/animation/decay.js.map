{"version":3,"names":["defineAnimation","isWeb","IS_WEB","withDecay","userConfig","callback","config","deceleration","velocityFactor","velocity","rubberBandFactor","Object","keys","forEach","key","VELOCITY_EPS","SLOPE_FACTOR","decay","rubberBandEffect","animation","now","lastTimestamp","startTimestamp","current","deltaTime","Math","min","clampIndex","abs","clamp","derivative","springActive","v","exp","initialVelocity","validateConfig","Array","isArray","Error","length","onStart","value","onFrame"],"sources":["decay.ts"],"sourcesContent":["import { defineAnimation } from './util';\nimport type {\n  Animation,\n  AnimationCallback,\n  AnimationObject,\n  AnimatableValue,\n  Timestamp,\n} from '../commonTypes';\nimport { isWeb } from '../PlatformChecker';\n\ninterface DecayConfig {\n  deceleration?: number;\n  velocityFactor?: number;\n  clamp?: number[];\n  velocity?: number;\n}\n\nexport type WithDecayConfig = DecayConfig;\n\ninterface DefaultDecayConfig {\n  deceleration: number;\n  velocityFactor: number;\n  clamp?: number[];\n  velocity: number;\n  rubberBandEffect?: boolean;\n  rubberBandFactor: number;\n}\n\nexport interface DecayAnimation extends Animation<DecayAnimation> {\n  lastTimestamp: Timestamp;\n  startTimestamp: Timestamp;\n  initialVelocity: number;\n  velocity: number;\n  current: AnimatableValue;\n}\n\ninterface InnerDecayAnimation\n  extends Omit<DecayAnimation, 'current'>,\n    AnimationObject {\n  current: number;\n}\n\nconst IS_WEB = isWeb();\n\n// TODO TYPESCRIPT This is a temporary type to get rid of .d.ts file.\ntype withDecayType = (\n  userConfig: DecayConfig,\n  callback?: AnimationCallback\n) => number;\n\nexport const withDecay = function (\n  userConfig: DecayConfig,\n  callback?: AnimationCallback\n): Animation<DecayAnimation> {\n  'worklet';\n\n  return defineAnimation<DecayAnimation>(0, () => {\n    'worklet';\n    const config: DefaultDecayConfig = {\n      deceleration: 0.998,\n      velocityFactor: 1,\n      velocity: 0,\n      rubberBandFactor: 0.6,\n    };\n    if (userConfig) {\n      Object.keys(userConfig).forEach(\n        (key) =>\n          ((config as any)[key] = userConfig[key as keyof typeof userConfig])\n      );\n    }\n\n    const VELOCITY_EPS = IS_WEB ? 1 / 20 : 1;\n    const SLOPE_FACTOR = 0.1;\n\n    let decay: (animation: InnerDecayAnimation, now: number) => boolean;\n\n    if (config.rubberBandEffect) {\n      decay = (animation: InnerDecayAnimation, now: number): boolean => {\n        const { lastTimestamp, startTimestamp, current, velocity } = animation;\n\n        const deltaTime = Math.min(now - lastTimestamp, 64);\n        const clampIndex =\n          Math.abs(current - config.clamp![0]) <\n          Math.abs(current - config.clamp![1])\n            ? 0\n            : 1;\n\n        let derivative = 0;\n        if (current < config.clamp![0] || current > config.clamp![1]) {\n          derivative = current - config.clamp![clampIndex];\n        }\n\n        if (derivative !== 0) {\n          animation.springActive = true;\n        } else if (derivative === 0 && animation.springActive) {\n          animation.current = config.clamp![clampIndex];\n          return true;\n        }\n\n        const v =\n          velocity *\n            Math.exp(\n              -(1 - config.deceleration) * (now - startTimestamp) * SLOPE_FACTOR\n            ) -\n          derivative * config.rubberBandFactor;\n\n        animation.current =\n          current + (v * config.velocityFactor * deltaTime) / 1000;\n        animation.velocity = v;\n        animation.lastTimestamp = now;\n        return false;\n      };\n    } else {\n      decay = (animation: InnerDecayAnimation, now: number): boolean => {\n        const {\n          lastTimestamp,\n          startTimestamp,\n          initialVelocity,\n          current,\n          velocity,\n        } = animation;\n\n        const deltaTime = Math.min(now - lastTimestamp, 64);\n        const v =\n          velocity *\n          Math.exp(\n            -(1 - config.deceleration) * (now - startTimestamp) * SLOPE_FACTOR\n          );\n        animation.current =\n          current + (v * config.velocityFactor * deltaTime) / 1000;\n        animation.velocity = v;\n        animation.lastTimestamp = now;\n\n        if (config.clamp) {\n          if (initialVelocity < 0 && animation.current <= config.clamp[0]) {\n            animation.current = config.clamp[0];\n            return true;\n          } else if (\n            initialVelocity > 0 &&\n            animation.current >= config.clamp[1]\n          ) {\n            animation.current = config.clamp[1];\n            return true;\n          }\n        }\n\n        return Math.abs(v) < VELOCITY_EPS;\n      };\n    }\n\n    function validateConfig(): void {\n      if (config.clamp) {\n        if (!Array.isArray(config.clamp)) {\n          throw Error(\n            `config.clamp must be an array but is ${typeof config.clamp}`\n          );\n        }\n        if (config.clamp.length !== 2) {\n          throw Error(\n            `clamp array must contain 2 items but is given ${config.clamp.length}`\n          );\n        }\n      }\n      if (config.velocityFactor <= 0) {\n        throw Error(\n          `config.velocityFactor must be greather then 0 but is ${config.velocityFactor}`\n        );\n      }\n      if (config.rubberBandEffect && !config.clamp) {\n        throw Error(\n          'You need to set `clamp` property when using `rubberBandEffect`.'\n        );\n      }\n    }\n\n    function onStart(\n      animation: DecayAnimation,\n      value: number,\n      now: Timestamp\n    ): void {\n      animation.current = value;\n      animation.lastTimestamp = now;\n      animation.startTimestamp = now;\n      animation.initialVelocity = config.velocity;\n      validateConfig();\n    }\n\n    return {\n      onFrame: decay,\n      onStart,\n      callback,\n      velocity: config.velocity ?? 0,\n      initialVelocity: 0,\n      current: 0,\n      lastTimestamp: 0,\n      startTimestamp: 0,\n    } as DecayAnimation;\n  });\n} as unknown as withDecayType;\n"],"mappings":"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"}